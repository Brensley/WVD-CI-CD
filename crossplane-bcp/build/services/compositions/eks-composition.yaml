apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: eks-cluster
  labels:
    provider: aws
spec:
  compositeTypeRef:
    apiVersion: compute.jne.rd/v1alpha1
    kind: XCluster
  resources:
    - name: eks
      base:
        apiVersion: eks.aws.upbound.io/v1beta1
        kind: Cluster
        spec:
          forProvider:
            region: us-east-1
            version: "1.29"
            roleArn: arn:aws:iam::123456789012:role/eks-control-plane
            resourcesVpcConfig:
              endpointPublicAccess: true
        patches:
          - fromFieldPath: spec.parameters.region
            toFieldPath: spec.forProvider.region
          - fromFieldPath: spec.parameters.version
            toFieldPath: spec.forProvider.version
    - name: nodegroup
      base:
        apiVersion: eks.aws.upbound.io/v1beta1
        kind: NodeGroup
        spec:
          forProvider:
            region: us-east-1
            clusterNameSelector:
              matchControllerRef: true
            nodeRoleArn: arn:aws:iam::123456789012:role/eks-node-role
            subnetIds:
              - subnet-0123456789abcdef0
            instanceType: t3.medium # default instance type
            diskSize: 50            # default disk size in GiB
            scalingConfig:
              desiredSize: 2
              maxSize: 2
              minSize: 1
      patches:
        - fromFieldPath: spec.parameters.region
          toFieldPath: spec.forProvider.region
        - fromFieldPath: spec.parameters.instanceType
          toFieldPath: spec.forProvider.instanceType
        - fromFieldPath: spec.parameters.diskSize
          toFieldPath: spec.forProvider.diskSize
    - name: jcp-nodegroup
      base:
        apiVersion: eks.aws.upbound.io/v1beta1
        kind: NodeGroup
        spec:
          forProvider:
            region: us-east-1
            clusterNameSelector:
              matchControllerRef: true
            nodeRoleArn: arn:aws:iam::123456789012:role/eks-jcp-node-role
            subnetIds:
              - subnet-0123456789abcdef0
            instanceType: t3.large # default instance type for JCP
            diskSize: 100          # default disk size in GiB
            scalingConfig:
              desiredSize: 3
              maxSize: 5
              minSize: 1
      patches:
        - fromFieldPath: spec.parameters.region
          toFieldPath: spec.forProvider.region
        - fromFieldPath: spec.parameters.jcpInstanceType
          toFieldPath: spec.forProvider.instanceType
        - fromFieldPath: spec.parameters.jcpDiskSize
          toFieldPath: spec.forProvider.diskSize
